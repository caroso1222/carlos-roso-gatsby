{"componentChunkName":"component---src-templates-blog-post-js","path":"/how-to-fix-droplet-100-disk-usage-docker/","result":{"data":{"markdownRemark":{"html":"<h1>TLDR</h1>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ docker system prune -a -f</code></pre></div>\n<div class=\"divider\"></div>\n<h1>The problem</h1>\n<p>All of a sudden my <a href=\"../deploying-frontend-applications-the-fun-way\">build server (aka droplet)</a> in DigitalOcean stopped building images. The Jenkins output for the failing job showed “No disk available”. Here’s what the disk usage metrics looked like:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 662px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d9fa99e2c0ba7a89184eba8c1a582741/c6720/disk-usage.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 31.325301204819272%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAkUlEQVQY032RCQpDIQxEvf9p1aKJxjjFuPR/KCIPM1mGiC5+EnJmAP19ekf/l7ugvcMRMZjVINJ3vDVNrboGdaAr1qPNsJSKEAQhtCveyzG84ZgLYhTE2K4MU5G5TWuDHevSc3N7svd1DT03lWP01D/kdY8eLgonrdmnEBUj54lprlazHBWkxHbvnpTZ2LVSBV+dfdXq+uT0JwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"disk usage\"\n        title=\"disk usage\"\n        src=\"/static/d9fa99e2c0ba7a89184eba8c1a582741/be86f/disk-usage.png\"\n        srcset=\"/static/d9fa99e2c0ba7a89184eba8c1a582741/e72ac/disk-usage.png 166w,\n/static/d9fa99e2c0ba7a89184eba8c1a582741/62452/disk-usage.png 331w,\n/static/d9fa99e2c0ba7a89184eba8c1a582741/be86f/disk-usage.png 662w,\n/static/d9fa99e2c0ba7a89184eba8c1a582741/0f7d5/disk-usage.png 993w,\n/static/d9fa99e2c0ba7a89184eba8c1a582741/eb2ef/disk-usage.png 1324w,\n/static/d9fa99e2c0ba7a89184eba8c1a582741/c6720/disk-usage.png 1922w\"\n        sizes=\"(max-width: 662px) 100vw, 662px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Notice the fix when disk utilization bumped down from 100% to 30%. Let’s see what happened.</p>\n<h1>The root cause</h1>\n<p>I have a native Jenkins installation in my droplet. Every job builds a docker image and pushes it to DockerHub. <strong>This was leaving dangling images after every build, thus consuming unnecessary disk space.</strong> These images are left in folder <code class=\"language-text\">/var/lib/docker/overlay2</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ cd /var/lib/docker\n$ du -sh ./*/\n20K\t    ./builder/\n...\n30.4G\t./overlay2/\n...\n28K\t    ./volumes/</code></pre></div>\n<p>As shown above, the dangling images accounted for 30.4 GBs. You can also see this with with <code class=\"language-text\">docker images -a</code>; the offending images are tagged as <code class=\"language-text\">&lt;none></code>.</p>\n<h1>The fix</h1>\n<p>Get rid of all those dangling images with docker prune:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ docker system prune -a -f\n$ cd /var/lib/docker &amp;&amp; du -sh ./*/\n20K\t    ./builder/\n...\n148K\t./overlay2/\n...\n28K\t    ./volumes/</code></pre></div>\n<p>Notice how I went from 30.4G to 148K in <code class=\"language-text\">overlay2</code>.</p>\n<h1>The real solution</h1>\n<p>It’d be ideal to build the image and remove the intermediate images in the process. I haven’t dig into this yet but <a href=\"https://stackoverflow.com/a/55082473/3468917\" target=\"_blank\" rel=\"nofollow\">this SO</a> answer looks promising.</p>\n<h1>Set an alarm</h1>\n<p>Finally, it’s always good to instrument your droplets and set alarms to act early on. In your Digital Ocean account go to <strong>Monitoring > Create alert policy</strong>. Select <strong>Disk Utilization</strong> and set a threshold of 80%.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 662px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a5326aeb8bdbc63ef532bf569a0bd53f/555cf/alert-policy.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 24.096385542168672%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA6klEQVQY022QO04EQQxE5ygkpEQcijMgkRBwE04DiJyAhYDVwu5M09/pabf7oR4C0EJJJUtllV32YIzhcDiQc6ajtcYxvqVGVXAz5NLY7BunV42z68b5DZxcwsUtDDF4ypKpUlCtFBHkH9ZaCSEwfXqKKDEr9xvl4UV4fBXunoWnXWX4sMLkhe1UsFHWJKr6h10PcWaaJrx3OGeR2QE/HlAGEyqjWxhdwSUhLb3Z1jvbL3aUUokxkVIixkgICamKKKtPamPYW2E7zuzMwrvJvI0LpbZ16/HAORestXjv1+qcW1/RA8Tcf6x8AdIsgDKC31oBAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"alert policy\"\n        title=\"alert policy\"\n        src=\"/static/a5326aeb8bdbc63ef532bf569a0bd53f/be86f/alert-policy.png\"\n        srcset=\"/static/a5326aeb8bdbc63ef532bf569a0bd53f/e72ac/alert-policy.png 166w,\n/static/a5326aeb8bdbc63ef532bf569a0bd53f/62452/alert-policy.png 331w,\n/static/a5326aeb8bdbc63ef532bf569a0bd53f/be86f/alert-policy.png 662w,\n/static/a5326aeb8bdbc63ef532bf569a0bd53f/0f7d5/alert-policy.png 993w,\n/static/a5326aeb8bdbc63ef532bf569a0bd53f/eb2ef/alert-policy.png 1324w,\n/static/a5326aeb8bdbc63ef532bf569a0bd53f/555cf/alert-policy.png 1960w\"\n        sizes=\"(max-width: 662px) 100vw, 662px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>","frontmatter":{"title":"How to fix droplet 100% disk usage","description":"Remove dangling images when building Docker from Jenkins","meta":null,"date":"December 26, 2020"}}},"pageContext":{"slug":"/how-to-fix-droplet-100-disk-usage-docker/","previous":{"fields":{"slug":"/2020-review/"},"frontmatter":{"title":"2020 - Review"}},"next":{"fields":{"slug":"/setup-github-ssh-access-from-jenkins/"},"frontmatter":{"title":"Setup Github SSH access from Jenkins"}}}},"staticQueryHashes":["3649515864","63159454"]}